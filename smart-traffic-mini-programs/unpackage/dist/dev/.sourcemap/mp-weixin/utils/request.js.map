{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["const TOKEN_KEY = \"token\";\r\nexport const BASE_URL = \"http://localhost:3005/api\";\r\nconst REQUEST_TIMEOUT = 15000;\r\nconst LOADING_DELAY = 50;\r\nlet loadingTimer;\r\n\r\nfunction getURL(url) {\r\n  if (!/https|http/.test(url)) {\r\n    return url.startsWith(\"/\") ? `${BASE_URL}${url}` : `${BASE_URL}/${url}`;\r\n  }\r\n  return url;\r\n}\r\n\r\nfunction requestInterceptor(config) {\r\n  const token = uni.getStorageSync(TOKEN_KEY);\r\n  if (token) {\r\n    config.header.Authorization = `Bearer ${token}`;\r\n  }\r\n  return config;\r\n}\r\n\r\nfunction responseInterceptor(response) {\r\n  if (response.statusCode === 401) {\r\n    uni.removeStorageSync(TOKEN_KEY);\r\n    uni.showToast({\r\n      title: \"登录过期，请重新登录\",\r\n      icon: \"none\",\r\n    });\r\n    uni.navigateTo({\r\n      url: \"/pages/auth/index\",\r\n    });\r\n  }\r\n  return response;\r\n}\r\n\r\nfunction request(options) {\r\n  return new Promise((resolve, reject) => {\r\n    let config = {\r\n      ...options,\r\n      url: getURL(options.url),\r\n      timeout: REQUEST_TIMEOUT,\r\n      header: {\r\n        \"Content-Type\": \"application/json\",\r\n        ...options.header,\r\n      },\r\n    };\r\n\r\n    config = requestInterceptor(config);\r\n\r\n    loadingTimer = setTimeout(() => {\r\n      uni.showLoading({\r\n        title: \"加载中\",\r\n      });\r\n    }, LOADING_DELAY);\r\n\r\n    uni.request({\r\n      ...config,\r\n      success: (res) => {\r\n        clearTimeout(loadingTimer);\r\n        uni.hideLoading();\r\n\r\n        const response = responseInterceptor(res);\r\n        if (!response) return;\r\n\r\n        if (res.statusCode >= 200 && res.statusCode < 300) {\r\n          resolve(res.data);\r\n        } else {\r\n          const error = new Error(res.data.message || \"请求失败\");\r\n          error.response = res;\r\n          error.status = res.statusCode;\r\n          reject(error);\r\n\r\n          uni.showToast({\r\n            title: res.data.message || \"请求失败\",\r\n            icon: \"none\",\r\n          });\r\n        }\r\n      },\r\n      fail: (err) => {\r\n        clearTimeout(loadingTimer);\r\n        uni.hideLoading();\r\n\r\n        const error = new Error(err.errMsg || \"网络错误\");\r\n        error.original = err;\r\n        reject(error);\r\n\r\n        uni.showToast({\r\n          title: \"网络错误\",\r\n          icon: \"none\",\r\n        });\r\n      },\r\n      complete: () => {\r\n        clearTimeout(loadingTimer);\r\n      },\r\n    });\r\n  });\r\n}\r\n\r\nexport const get = (params) => {\r\n  return request({ ...params, method: \"GET\" });\r\n};\r\n\r\nexport const post = (params) => {\r\n  return request({ ...params, method: \"POST\" });\r\n};\r\n\r\nexport const put = (params) => {\r\n  return request({ ...params, method: \"PUT\" });\r\n};\r\n\r\nexport const del = (params) => {\r\n  return request({ ...params, method: \"DELETE\" });\r\n};\r\n\r\nexport const patch = (params) => {\r\n  return request({ ...params, method: \"PATCH\" });\r\n};"],"names":["uni"],"mappings":";;AAAA,MAAM,YAAY;AACX,MAAM,WAAW;AACxB,MAAM,kBAAkB;AACxB,MAAM,gBAAgB;AACtB,IAAI;AAEJ,SAAS,OAAO,KAAK;AACnB,MAAI,CAAC,aAAa,KAAK,GAAG,GAAG;AAC3B,WAAO,IAAI,WAAW,GAAG,IAAI,GAAG,QAAQ,GAAG,GAAG,KAAK,GAAG,QAAQ,IAAI,GAAG;AAAA,EACtE;AACD,SAAO;AACT;AAEA,SAAS,mBAAmB,QAAQ;AAClC,QAAM,QAAQA,cAAAA,MAAI,eAAe,SAAS;AAC1C,MAAI,OAAO;AACT,WAAO,OAAO,gBAAgB,UAAU,KAAK;AAAA,EAC9C;AACD,SAAO;AACT;AAEA,SAAS,oBAAoB,UAAU;AACrC,MAAI,SAAS,eAAe,KAAK;AAC/BA,wBAAI,kBAAkB,SAAS;AAC/BA,kBAAAA,MAAI,UAAU;AAAA,MACZ,OAAO;AAAA,MACP,MAAM;AAAA,IACZ,CAAK;AACDA,kBAAAA,MAAI,WAAW;AAAA,MACb,KAAK;AAAA,IACX,CAAK;AAAA,EACF;AACD,SAAO;AACT;AAEA,SAAS,QAAQ,SAAS;AACxB,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,QAAI,SAAS;AAAA,MACX,GAAG;AAAA,MACH,KAAK,OAAO,QAAQ,GAAG;AAAA,MACvB,SAAS;AAAA,MACT,QAAQ;AAAA,QACN,gBAAgB;AAAA,QAChB,GAAG,QAAQ;AAAA,MACZ;AAAA,IACP;AAEI,aAAS,mBAAmB,MAAM;AAElC,mBAAe,WAAW,MAAM;AAC9BA,oBAAAA,MAAI,YAAY;AAAA,QACd,OAAO;AAAA,MACf,CAAO;AAAA,IACF,GAAE,aAAa;AAEhBA,kBAAAA,MAAI,QAAQ;AAAA,MACV,GAAG;AAAA,MACH,SAAS,CAAC,QAAQ;AAChB,qBAAa,YAAY;AACzBA,sBAAG,MAAC,YAAW;AAEf,cAAM,WAAW,oBAAoB,GAAG;AACxC,YAAI,CAAC;AAAU;AAEf,YAAI,IAAI,cAAc,OAAO,IAAI,aAAa,KAAK;AACjD,kBAAQ,IAAI,IAAI;AAAA,QAC1B,OAAe;AACL,gBAAM,QAAQ,IAAI,MAAM,IAAI,KAAK,WAAW,MAAM;AAClD,gBAAM,WAAW;AACjB,gBAAM,SAAS,IAAI;AACnB,iBAAO,KAAK;AAEZA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO,IAAI,KAAK,WAAW;AAAA,YAC3B,MAAM;AAAA,UAClB,CAAW;AAAA,QACF;AAAA,MACF;AAAA,MACD,MAAM,CAAC,QAAQ;AACb,qBAAa,YAAY;AACzBA,sBAAG,MAAC,YAAW;AAEf,cAAM,QAAQ,IAAI,MAAM,IAAI,UAAU,MAAM;AAC5C,cAAM,WAAW;AACjB,eAAO,KAAK;AAEZA,sBAAAA,MAAI,UAAU;AAAA,UACZ,OAAO;AAAA,UACP,MAAM;AAAA,QAChB,CAAS;AAAA,MACF;AAAA,MACD,UAAU,MAAM;AACd,qBAAa,YAAY;AAAA,MAC1B;AAAA,IACP,CAAK;AAAA,EACL,CAAG;AACH;AAEY,MAAC,MAAM,CAAC,WAAW;AAC7B,SAAO,QAAQ,EAAE,GAAG,QAAQ,QAAQ,MAAO,CAAA;AAC7C;;"}